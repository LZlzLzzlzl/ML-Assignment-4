name: Build Executables (Reinforcement Learning Assignment)

on:
  push:
    branches: [ main ]
    paths:
      - 'requirements.txt'
      - '.github/workflows/main.yml'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.8
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
        cache: 'pip'

    - name: Create evaluate.py from Secret
      env:
        EVALUATE_CODE: ${{ secrets.EVALUATE_PY_CODE }}
      run: |
        echo "$EVALUATE_CODE" > evaluate.py
        if [ ! -s evaluate.py ]; then
          echo "[ERROR] evaluate.py is empty! Check EVALUATE_PY_CODE Secret"
          exit 1
        fi
      shell: bash

    - name: Install PyArmor (Anti-Decompile Tool)
      run: |
        python -m pip install --upgrade pip
        pip install "pyarmor>=8.0.0"
        pyarmor --version
        
        if [[ "$RUNNER_OS" == "macOS" ]]; then
          echo "Pre-downloading macOS core libraries..."
          mkdir -p ~/.pyarmor/platforms/darwin/aarch64/3

          curl -L --fail https://github.com/dashingsoft/pyarmor-core/raw/r52.6/platforms/darwin.arm64.3/_pytransform.dylib \
            -o ~/.pyarmor/platforms/darwin/aarch64/3/_pytransform.dylib || echo "Download failed, will rely on PyArmor auto-download"
        fi
      shell: bash

    - name: Encrypt / obfuscate evaluate.py with PyArmor
      run: |

        pyarmor gen --output pyarmor_dist evaluate.py
        

        echo "PyArmor output structure:"
        find pyarmor_dist -type f -name "*.py" | head -10
        ls -la pyarmor_dist/ || true
      shell: bash

    - name: Install dependencies (PyInstaller + requirements)
      run: |
        pip install pyinstaller==5.13.2
        if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
        pip list
      shell: bash

    # ------------------------------
    # Linux build (ubuntu-latest)
    # ------------------------------
    - name: Build with PyInstaller (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |

        ENTRY_SCRIPT="pyarmor_dist/dist/evaluate.py"
        RUNTIME_DIR="pyarmor_dist/dist/pyarmor_runtime"
        
        echo "Entry script: $ENTRY_SCRIPT"
        echo "Runtime dir: $RUNTIME_DIR"
        
        ls -la pyarmor_dist/dist/ || true
        
        pyinstaller --onefile \
          --name evaluate-linux \
          --hidden-import numpy \
          --hidden-import requests \
          --hidden-import scipy \
          --hidden-import matplotlib \
          --hidden-import seaborn \
          --hidden-import gym \
          --hidden-import requests.adapters \
          --hidden-import 'numpy.core._multiarray_umath' \
          --add-data "$RUNTIME_DIR:pyarmor_runtime" \
          "$ENTRY_SCRIPT"
        ls -la dist || true
      shell: bash

    # ------------------------------
    # macOS build (macos-latest)
    # ------------------------------
    - name: Build with PyInstaller (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        ENTRY_SCRIPT="pyarmor_dist/dist/evaluate.py"
        RUNTIME_DIR="pyarmor_dist/dist/pyarmor_runtime"
        
        echo "Entry script: $ENTRY_SCRIPT"
        echo "Runtime dir: $RUNTIME_DIR"
        
        ls -la pyarmor_dist/dist/ || true
        
        pyinstaller --onefile \
          --name evaluate-macos \
          --hidden-import numpy \
          --hidden-import requests \
          --hidden-import scipy \
          --hidden-import matplotlib \
          --hidden-import seaborn \
          --hidden-import gym \
          --hidden-import 'numpy.core._multiarray_umath' \
          --add-data "$RUNTIME_DIR:pyarmor_runtime" \
          "$ENTRY_SCRIPT"
        ls -la dist || true
      shell: bash

    # ------------------------------
    # Windows build (windows-latest)
    # ------------------------------
    - name: Build with PyInstaller (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # 使用PowerShell on Windows runner
        python -m pip install --upgrade pip
        python -m pip install pyinstaller==5.13.2
        

        $ENTRY_SCRIPT = "pyarmor_dist\dist\evaluate.py"
        $RUNTIME_DIR = "pyarmor_dist\dist\pyarmor_runtime"
        
        Write-Host "Entry script: $ENTRY_SCRIPT"
        Write-Host "Runtime dir: $RUNTIME_DIR"
        

        Get-ChildItem -Path "pyarmor_dist\dist" -Recurse -ErrorAction SilentlyContinue

        pyinstaller --onefile `
          --name evaluate-windows `
          --hidden-import numpy `
          --hidden-import requests `
          --hidden-import scipy `
          --hidden-import matplotlib `
          --hidden-import seaborn `
          --hidden-import gym `
          --hidden-import "numpy.core._multiarray_umath" `
          --add-data "$RUNTIME_DIR;pyarmor_runtime" `
          "$ENTRY_SCRIPT"
        Get-ChildItem -Path dist -Recurse

    - name: Cleanup all temporary files
      if: always()
      run: |
        rm -f evaluate.py || true
        rm -rf pyarmor_dist || true
        rm -rf build || true
        rm -f *.spec || true
      shell: bash

    - name: Upload artifact (per-OS)
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os == 'ubuntu-latest' && 'evaluate-linux' || matrix.os == 'macos-latest' && 'evaluate-macos' || 'evaluate-windows' }}
        path: |
          ${{ matrix.os == 'ubuntu-latest' && 'dist/evaluate-linux' || '' }}
          ${{ matrix.os == 'macos-latest' && 'dist/evaluate-macos' || '' }}
          ${{ matrix.os == 'windows-latest' && 'dist/evaluate-windows.exe' || '' }}
        retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: evaluate-linux
        path: evaluate-linux

    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: evaluate-macos
        path: evaluate-macos

    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: evaluate-windows
        path: evaluate-windows

    - name: List downloaded files
      run: |
        echo "==== Linux ===="
        ls -la evaluate-linux/ || true
        echo "==== macOS ===="
        ls -la evaluate-macos/ || true
        echo "==== Windows ===="
        ls -la evaluate-windows/ || true

    - name: Create GitHub Release (attach executables)
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        draft: false
        prerelease: false
        files: |
          evaluate-linux/evaluate-linux
          evaluate-macos/evaluate-macos
          evaluate-windows/evaluate-windows.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
